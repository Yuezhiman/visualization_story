<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>‰∫∫Áâ©Êó∂Èó¥Á∫ø</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
   <script src="js/events.js" defer></script>
</head>
<style>
    html, body {
      margin: 10;
      font-family: sans-serif;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

#main {
    display: flex;
    flex: 1;
    overflow: hidden;
    justify-content: space-around;
}

#flower-plot {
      margin-top: 30px;
    }
    .flower-node {
      cursor: pointer;
      stroke: #eb1111;
      stroke-width: 1;
      opacity: 0.8;
    }
    .flower-label {
      font-size: 10px;
      fill: #e4d912;
    }
    .legend text {
      font-size: 12px;
      fill: #1790e7;
    }
#event-display {
    flex: 1;
    padding: 20px;
    overflow: auto;
    background: #f5f5f5;
}

#timeline {
    margin-top: 20px; 
    overflow-x: auto;
    white-space: nowrap;
    background: #f8f8f8;
    padding: 10px 0;  
}

.event-box {
    background: #fff;
    padding: 15px;
    border: 1px solid #ccc;
    max-width: 700px;
    margin: auto;
}


img, video {
    max-width: 100%;
    margin-top: 10px;
}
#controls button {
  margin: 5px;
  padding: 8px 12px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background-color: #eee;
  cursor: pointer;
}
#controls button:hover {
  background-color: #ddd;
}

.event-marker, .flower-node {
    fill: gray;
    cursor: pointer;
    stroke: #000;
    stroke-width: 1;
}

.active {
    stroke: red;
    stroke-width: 3;
}

.marker-label {
    font-size: 12px;
    text-anchor: middle;
    fill: #fff;
    pointer-events: none;
}

.mountain {
    fill: lightgray;
    opacity: 0.4;
}

#media-container {
  width: 100%;
  text-align: center;
  margin-top: 10px;
}

.media-display {
  max-width: 100%;
  max-height: 300px;
  border-radius: 8px;
  object-fit: contain;
}


</style>
<body>

<div id="controls">
  <button onclick="startAutoPlay()">‚ñ∂Ô∏è Êí≠Êîæ</button>
  <button onclick="stopAutoPlay()">‚è∏ ÊöÇÂÅú</button>
  <button id="prev">‚èÆÔ∏è ‰∏ä‰∏ÄÊù°</button>
</div>

<div id="main">
  <div id="flower-plot"></div>
  <div id="event-display">
    <h2 id="event-title"></h2>
    <p id="event-time"></p>
  <p id="event-description"></p>
  <div id="media-display"></div>
  </div>
  

</div>

<div id="timeline"></div>

<script>

let currentIndex = 0;
let autoplayTimer = null;
let isManualInterruption = false;  

const peakThreshold = 0.6;
const categoryColor = {
  "ËÅå‰∏ö": "#4CAF50",
  "ÂÆ∂Â∫≠": "#2196F3",
  "Á§æ‰ºöË¥£‰ªª": "#FFC107",
  "ÂÖ∂‰ªñ": "#9E9E9E"
};
function renderFlowerPlot() {
  const width = 500;
  const height = 500;
  const center = { x: width / 2, y: height / 2 };
  const radius = 120;

  const svg = d3.select("#flower-plot")
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("viewBox", `0 0 ${width} ${height}`)
    .attr("preserveAspectRatio", "xMidYMid meet");

  // Ê∏êÂèòÂíåÈò¥ÂΩ±
  const defs = svg.append("defs");
  Object.entries(categoryColor).forEach(([category, color]) => {
    const gradient = defs.append("radialGradient")
      .attr("id", `grad-${category}`)
      .attr("cx", "50%").attr("cy", "50%").attr("r", "50%");
    gradient.append("stop").attr("offset", "0%").attr("stop-color", d3.color(color).brighter(1));
    gradient.append("stop").attr("offset", "100%").attr("stop-color", color);
  });

  defs.append("filter")
    .attr("id", "drop-shadow")
    .html(`<feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#aaa" />`);

  // ‰∏≠ÂøÉÂúÜÂíåÊ†áÈ¢ò
  svg.append("circle")
    .attr("cx", center.x)
    .attr("cy", center.y)
    .attr("r", radius)
    .attr("fill", "none")
    .attr("stroke", "#ccc")
    .attr("stroke-width", 2)
    .attr("stroke-dasharray", "4 2");

  svg.append("text")
    .attr("x", center.x)
    .attr("y", center.y + 5)
    .attr("text-anchor", "middle")
    .attr("font-size", "16px")
    .attr("fill", "#666")
    .text("‰∫∫Áâ©ÁîüÂπ≥Ê¶ÇËßà");

  const inside = events.filter(d => d.peak >= peakThreshold);
  const outside = events.filter(d => d.peak < peakThreshold);

  // ÂùêÊ†áËÆ°ÁÆó
  inside.forEach((d, i) => {
    const angle = 2 * Math.PI * i / inside.length;
    d.x = center.x + radius * 0.6 * Math.cos(angle);
    d.y = center.y + radius * 0.6 * Math.sin(angle);
  });

  outside.forEach((d, i) => {
    const angle = 2 * Math.PI * i / outside.length;
    d.x = center.x + radius * 1.4 * Math.cos(angle);
    d.y = center.y + radius * 1.4 * Math.sin(angle);
  });

  const all = [...inside, ...outside];
  // Ê∑ªÂä†ËøûÊé•Á∫ø

  svg.selectAll(".flower-node")
    .data(all)
    .enter()
    .append("circle")
    .attr("class", "flower-node")
    .attr("cx", center.x)
    .attr("cy", center.y)
    .attr("r", 0)
    .attr("fill", d => `url(#gradient-${d.category})`)
    .attr("filter", "url(#drop-shadow)")
    .transition()
    .duration(1000)
    .ease(d3.easeBackOut)
    // ‰ΩøÁî® d3.easeBackOut ‰ΩøÂä®ÁîªÊõ¥Ëá™ÁÑ∂
    .attr("cx", d => d.x)
    .attr("cy", d => d.y)
    .attr("r", d => 6 + d.peak * 6) // Ê†πÊçÆ peak Âä®ÊÄÅËÆæÁΩÆÂ§ßÂ∞è
    .on("end", function() {
      d3.select(this)
        .on("click", (e, d) => showEvent(d))
        .style("cursor", "pointer");
    });

  // Âõæ‰æã
  const legend = svg.append("g")
    .attr("transform", `translate(20, ${height - 100})`);

  Object.entries(categoryColor).forEach(([category, color], i) => {
    const g = legend.append("g")
      .attr("transform", `translate(0, ${i * 22})`);
    g.append("circle")
      .attr("r", 8)
      .attr("fill", `url(#grad-${category})`);
    g.append("text")
      .attr("x", 15)
      .attr("y", 5)
      .text(category)
      .attr("fill", "#333")
      .attr("font-size", "14px");
  });
}
function renderTimeline() {
  const timelineDiv = document.getElementById("timeline");
  timelineDiv.innerHTML = ""; // Ê∏ÖÁ©∫ÊóßÂõæ
  timelineDiv.style.overflowX = "auto";

  const svgWidth = 2000;
  const svgHeight = 200;

  const timeline = d3.select(timelineDiv).append("svg")
    .attr("width", svgWidth)
    .attr("height", svgHeight);

  const x = d3.scaleTime()
    .domain([
      d3.min(events, d => d.start),
      d3.max(events, d => d.end)
    ])
    .range([60, svgWidth - 60]);

  const area = d3.area()
    .x(d => x(d.start))
    .y0(svgHeight)
    .y1(d => svgHeight - (d.peak || 0) * 100)
    .curve(d3.curveMonotoneX);;

  // Ê∏êÂèòËâ≤ÂÆö‰πâ
  const defs = timeline.append("defs");
  const gradient = defs.append("linearGradient")
    .attr("id", "mountain-gradient")
    .attr("x1", "0%").attr("x2", "0%")
    .attr("y1", "0%").attr("y2", "100%");

  gradient.selectAll("stop")
    .data([
      { offset: "0%", color: "#80c1ff" },
      { offset: "100%", color: "#ffffff" }
    ])
    .enter()
    .append("stop")
    .attr("offset", d => d.offset)
    .attr("stop-color", d => d.color);

  // Â±±Â≥∞Âå∫ÂüüÂõæ
  timeline.append("path")
    .datum(events)
    .attr("class", "mountain")
    .attr("d", area)
    .attr("fill", "url(#mountain-gradient)");

  // Êó∂Èó¥ËΩ¥
  timeline.append("g")
    .attr("transform", "translate(0,180)")
    .call(d3.axisBottom(x).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y")));

  // Êó∂Èó¥ÊÆµÊ®™Êù°
  timeline.selectAll(".duration-bar")
    .data(events)
    .enter()
    .append("rect")
    .attr("class", "duration-bar")
    .attr("x", d => x(d.start))
    .attr("y", 150)
    .attr("height", 4)
    .attr("width", d => Math.max(2, x(d.end) - x(d.start)))
    .attr("fill", "#aaa")
    .on("click", (e, d) => showEvent(d));

  // üèÄ ‰∫ã‰ª∂ÂõæÊ†áÂèäÊ†áÁ≠æÔºàÁî®ÁÆ≠Â§¥ÊåáÂêëÔºâ
  const markers = timeline.selectAll(".event-marker")
    .data(events)
    .enter()
    .append("g")
    .attr("transform", d => `translate(${x(d.start)}, 180)`)
    .on("click", (e, d) => showEvent(d));

  // üèÄ ÂõæÊ†áÔºàÁØÆÁêÉÔºâ
  markers.append("text")
    .attr("text-anchor", "middle")
    .attr("font-size", "20px")
    .attr("y", 0)
    .text("üèÄ");
    // Âú® timeline svg ÂÜÖÂàõÂª∫‰∏Ä‰∏™ÁØÆÁêÉÂõæÊ†áÔºàÂè™‰∏Ä‰∏™Ôºâ
  // ‚¨ÜÔ∏è Ê†áÁ≠æÊñáÂ≠ó
  // ÂéüÊù•ÁöÑ marker.append("text") 
  // ÂÖàÂàõÂª∫Á©∫ÊñáÊú¨ÂÖÉÁ¥†Ôºå‰∏çËÆæÁΩÆ text()
  const label = markers.append("text")
    .attr("y", (d, i) => i % 2 === 0 ? -45 : -70) // ‰∏ä‰∏ã‰∫§Èîô
    .attr("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("font-family", "sans-serif")
    .attr("fill", "#000");

  // Áî® tspan ÂàÜË°åÂÜôÂÆåÊï¥ÊñáÊú¨
  label.each(function(d) {
    const textLines = d.title.split("Ôºö"); // ÂàÜË°å
    textLines.forEach((line, i) => {
      d3.select(this).append("tspan")
        .attr("x", 0)
        .attr("dy", i === 0 ? 0 : "1.2em")
        .text(line);
    });
  });


  // ‚¨ÜÔ∏è ÁÆ≠Â§¥Á∫øÊù°
  markers.append("line")
    .attr("x1", 0).attr("y1", -28)
    .attr("x2", 0).attr("y2", -5)
    .attr("stroke", "#999")
    .attr("stroke-width", 1);

  // Tooltip ÊèêÁ§∫ÔºàÊÇ¨ÂÅúÂÆåÊï¥Ê†áÈ¢ò + Êó∂Èó¥Ôºâ
  markers.append("title")
    .text(d => `${d.title}Ôºö${d3.timeFormat("%Y-%m-%d")(d.start)} - ${d3.timeFormat("%Y-%m-%d")(d.end)}`);

  // ÊãñÊãΩÊªöÂä®ÈÄªËæë
  let isDragging = false, startX = 0, scrollLeft = 0;
  timelineDiv.addEventListener("mousedown", e => {
    isDragging = true;
    startX = e.pageX - timelineDiv.offsetLeft;
    scrollLeft = timelineDiv.scrollLeft;
  });
  timelineDiv.addEventListener("mouseleave", () => isDragging = false);
  timelineDiv.addEventListener("mouseup", () => isDragging = false);
  timelineDiv.addEventListener("mousemove", e => {
    if (!isDragging) return;
    const xPos = e.pageX - timelineDiv.offsetLeft;
    const walk = (xPos - startX) * 1.5;
    timelineDiv.scrollLeft = scrollLeft - walk;
  });
}



// 
function showEvent(event, fromAutoplay = false) {
  let imageIndex = 0;
  if (!fromAutoplay) {
    // Áî®Êà∑ÁÇπÂáªÊó∂‰∏≠Êñ≠Ëá™Âä®Êí≠Êîæ
    stopAutoPlay();
    isManualInterruption = true;
  }

  d3.selectAll(".event-marker").classed("active", e => e === event);
  d3.selectAll(".flower-node").classed("active", e => e === event);

  const display = d3.select("#event-display").html("");
  const box = display.append("div").attr("class", "event-box");
  const mediaBox = box.append("div").attr("class", "media-carousel");

  box.append("h2").text(event.title);
  box.append("p").text(event.description);
  // box‰∏≠Â§öÂº†ÂõæÁâáÔºåÊ®°ÊÄÅÔºåÊªöÂä®ÂëàÁé∞

  
  // if (event.image) {
  //   event.image.forEach(img => box.append("img").attr("src", "images/" + img));
  // }

  // if (event.video) {
  //   box.append("video")
  //     .attr("src", "videos/" + event.video)
  //     .attr("controls", true)
  //     .attr("autoplay", true);
  // }
//   if (event.image) {
//   event.image.forEach(img =>
//     mediaBox.append("img")
//       .attr("src", "images/" + img)
//       .attr("class", "media-item")
//   );
// }

// if (event.video) {
//   mediaBox.append("video")
//     .attr("src", "videos/" + event.video)
//     .attr("class", "media-item")
//     .attr("controls", true);
// }

const mediaContainer = box.append("div").attr("id", "media-container");
const controlBox = box.append("div").attr("class", "media-controls");

controlBox.append("button")
  .text("‚èÆÔ∏è ‰∏ä‰∏ÄÂº†")
  .on("click", () => {
    mediaIndex = (mediaIndex - 1 + mediaItems.length) % mediaItems.length;
    showMediaItem(mediaIndex);
  });

controlBox.append("button")
  .text("‚è≠Ô∏è ‰∏ã‰∏ÄÂº†")
  .on("click", () => {
    nextMedia();
  });

let mediaItems = [];
if (event.image) {
  event.image.forEach(img => {
    mediaItems.push({ type: "image", src: "images/" + img });
  });
}
if (event.video) {
  mediaItems.push({ type: "video", src: "videos/" + event.video });
}

let mediaIndex = 0;

function showMediaItem(index) {
  mediaContainer.html(""); // Ê∏ÖÁ©∫ÂÆπÂô®
  const item = mediaItems[index];

  if (item.type === "image") {
    mediaContainer.append("img")
      .attr("src", item.src)
      .attr("class", "media-display");
    scheduleNext();
  } else if (item.type === "video") {
    const video = mediaContainer.append("video")
      .attr("src", item.src)
      .attr("class", "media-display")
      .attr("controls", true)
      .attr("autoplay", true)
      .node();

    video.onended = () => {
      nextMedia();
    };
  }
}

function nextMedia() {
  mediaIndex = (mediaIndex + 1) % mediaItems.length;
  showMediaItem(mediaIndex);
}

let mediaTimer = null;
function scheduleNext() {
  clearTimeout(mediaTimer);
  mediaTimer = setTimeout(() => {
    nextMedia();
  }, 4000); // ÂõæÁâá 4 ÁßíÂàáÊç¢
}

if (mediaItems.length > 0) {
  showMediaItem(mediaIndex);
}



}




// ËÆæÁΩÆËá™Âä®Êí≠Êîæevents‰∏≠ÁöÑÂÜÖÂÆπ
let intervalId = null;
function startAutoPlay() {
  stopAutoPlay();
  isManualInterruption = false; // ÈáçÁΩÆÊ†áÂøó

  autoplayTimer = setInterval(() => {
    if (!isManualInterruption) {
      showEvent(events[currentIndex], true); // Ëá™Âä®Êí≠ÊîæÁî® true
      currentIndex = (currentIndex + 1) % events.length;
    }
  }, 5000);
}


function stopAutoPlay() {
  if (autoplayTimer) {
    clearInterval(autoplayTimer);
    autoplayTimer = null;
  }
}
document.addEventListener("DOMContentLoaded", () => {
  renderFlowerPlot();
  renderTimeline();
  showEvent(events[0]);
  startAutoPlay();
});
</script>

</body>
</html>