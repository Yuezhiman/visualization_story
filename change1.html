<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>人物时间线</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
   <script src="js/events.js" defer></script>
</head>
<style>
    html, body {
      margin: 10;
      font-family: sans-serif;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: #f0f0f0;
    }

#main {
    display: flex;
    flex: 1;
    overflow: hidden;
    justify-content: space-around;
}

#flower-plot {
      margin-top: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
    }
    .flower-node {
      cursor: pointer;
      stroke: white;
      stroke-width: 1;
      opacity: 0.9;
      transition: all 0.3s ease;
    }
    .flower-node:hover {
      stroke-width: 3;
      stroke: #333;
    }
    .flower-label {
      font-size: 10px;
      fill: #333;
      font-weight: 500;
    }
    .legend text {
      font-size: 12px;
      fill: #333;
    }
#event-display {
    flex: 1;
    padding: 20px;
    overflow: auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-left: 20px;
}

#timeline {
    margin-top: 20px; 
    overflow-x: auto;
    white-space: nowrap;
    background: white;
    padding: 20px 0;  
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.event-box {
    background: #fff;
    padding: 15px;
    border: 1px solid #eee;
    max-width: 700px;
    margin: auto;
    border-radius: 8px;
}


img, video {
    max-width: 100%;
    margin-top: 10px;
    border-radius: 8px;
}
#controls {
  display: flex;
  justify-content: center;
  margin: 20px 0;
  padding: 10px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
#controls button {
  margin: 5px;
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background-color: #4CAF50;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
}
#controls button:hover {
  background-color: #45a049;
  transform: translateY(-2px);
}

.event-marker, .flower-node {
    cursor: pointer;
    stroke: #000;
    stroke-width: 1;
}

.active {
    stroke: red;
    stroke-width: 3;
}

.marker-label {
    font-size: 12px;
    text-anchor: middle;
    fill: #333;
    pointer-events: none;
}

.mountain {
    fill: #80c1ff;
    opacity: 0.6;
}

#media-container {
  width: 100%;
  text-align: center;
  margin-top: 10px;
}

.media-display {
  max-width: 100%;
  max-height: 300px;
  border-radius: 8px;
  object-fit: contain;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#event-title {
  color: #2c3e50;
  border-bottom: 2px solid #4CAF50;
  padding-bottom: 10px;
}

#event-description {
  line-height: 1.6;
  color: #555;
}

#event-time {
  color: #7f8c8d;
  font-style: italic;
}

.media-controls {
  display: flex;
  justify-content: center;
  margin-top: 15px;
}

.media-controls button {
  margin: 0 10px;
  padding: 8px 16px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

</style>
<body>

<div id="controls">
  <button onclick="startAutoPlay()">▶️ 播放</button>
  <button onclick="stopAutoPlay()">⏸ 暂停</button>
  <button id="prev" onclick="prevEvent()">⏮️ 上一条</button>
  <button id="next" onclick="nextEvent()">⏭️ 下一条</button>
</div>

<div id="main">
  <div id="flower-plot"></div>
  <div id="event-display">
    <h2 id="event-title"></h2>
    <p id="event-time"></p>
    <p id="event-description"></p>
    <div id="media-container"></div>
    <div class="media-controls">
      <button onclick="prevMedia()">⏮️ 上一张</button>
      <button onclick="nextMedia()">⏭️ 下一张</button>
    </div>
  </div>
</div>

<div id="timeline"></div>

<script>



let currentIndex = 0;
let autoplayTimer = null;
let isManualInterruption = false;  
let mediaIndex = 0;
let mediaItems = [];
let mediaTimer = null;

const peakThreshold = 0.6;
const categoryColor = {
  "职业": "#4CAF50",
  "家庭": "#2196F3",
  "社会责任": "#FFC107",
  "其他": "#9E9E9E"
};

function renderFlowerPlot() {
  const width = 500;
  const height = 500;
  const center = { x: width / 2, y: height / 2 };
  const radius = 120;

  // 清除之前的SVG
  d3.select("#flower-plot").html("");
  
  const svg = d3.select("#flower-plot")
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("viewBox", `0 0 ${width} ${height}`)
    .attr("preserveAspectRatio", "xMidYMid meet");

  // 添加背景圆形
  svg.append("circle")
    .attr("cx", center.x)
    .attr("cy", center.y)
    .attr("r", radius + 60)
    .attr("fill", "#f8f9fa")
    .attr("stroke", "#e9ecef")
    .attr("stroke-width", 1);
    
  // 定义渐变
  const defs = svg.append("defs");
  
  // 添加阴影滤镜
  defs.append("filter")
    .attr("id", "drop-shadow")
    .attr("x", "-50%")
    .attr("y", "-50%")
    .attr("width", "200%")
    .attr("height", "200%")
    .append("feDropShadow")
    .attr("dx", 0)
    .attr("dy", 2)
    .attr("stdDeviation", 3)
    .attr("flood-color", "rgba(0, 0, 0, 0.3)");
  
  // 添加装饰性圆圈
  for (let i = 0; i < 3; i++) {
    const r = radius + i * 20;
    svg.append("circle")
      .attr("cx", center.x)
      .attr("cy", center.y)
      .attr("r", r)
      .attr("fill", "none")
      .attr("stroke", `rgba(0, 0, 0, ${0.05 - i*0.01})`)
      .attr("stroke-width", 1)
      .attr("stroke-dasharray", i === 0 ? "4 2" : "2 2");
  }
  
  // 中心标题
  svg.append("text")
    .attr("x", center.x)
    .attr("y", center.y - 10)
    .attr("text-anchor", "middle")
    .attr("font-size", "18px")
    .attr("fill", "#2c3e50")
    .attr("font-weight", "bold")
    .text("人物生平概览");
    
  svg.append("text")
    .attr("x", center.x)
    .attr("y", center.y + 15)
    .attr("text-anchor", "middle")
    .attr("font-size", "14px")
    .attr("fill", "#7f8c8d")
    .text(`${events.length}个重要事件`);

  // 分离内部和外部事件
  const inside = events.filter(d => d.peak >= peakThreshold);
  const outside = events.filter(d => d.peak < peakThreshold);
  
  // 计算位置
  inside.forEach((d, i) => {
    const angle = (2 * Math.PI * i / inside.length) - Math.PI/2;
    d.x = center.x + radius * 0.6 * Math.cos(angle);
    d.y = center.y + radius * 0.6 * Math.sin(angle);
  });

  outside.forEach((d, i) => {
    const angle = (2 * Math.PI * i / outside.length) - Math.PI/2;
    d.x = center.x + radius * 1.4 * Math.cos(angle);
    d.y = center.y + radius * 1.4 * Math.sin(angle);
  });

  const all = [...inside, ...outside];

  // 添加连接线
  all.forEach(d => {
    svg.append("line")
      .attr("x1", center.x)
      .attr("y1", center.y)
      .attr("x2", center.x)
      .attr("y2", center.y)
      .attr("stroke", "rgba(0, 0, 0, 0.1)")
      .attr("stroke-width", 1)
      .transition()
      .duration(1000)
      .ease(d3.easeCubicOut)
      .attr("x2", d.x)
      .attr("y2", d.y);
  });

  // 添加事件点 - 使用纯色
  const nodes = svg.selectAll(".flower-node")
    .data(all)
    .enter()
    .append("circle")
    .attr("class", "flower-node")
    .attr("cx", center.x)
    .attr("cy", center.y)
    .attr("r", 0)
    .attr("fill", d => categoryColor[d.category] || "#9E9E9E")
    .attr("filter", "url(#drop-shadow)")
    .attr("stroke", "white")
    .attr("stroke-width", 0)
    .on("mouseover", function(event, d) {
      d3.select(this)
        .attr("stroke-width", 2)
        .attr("r", 8 + d.peak * 6);
    })
    .on("mouseout", function(event, d) {
      d3.select(this)
        .attr("stroke-width", 0)
        .attr("r", 6 + d.peak * 6);
    })
    .on("click", function(event, d) {
      showEvent(d);
    });
    
  // 动画效果
  nodes.transition()
    .duration(1200)
    .ease(d3.easeElasticOut)
    .attr("cx", d => d.x)
    .attr("cy", d => d.y)
    .attr("r", d => 6 + d.peak * 6)
    .attr("opacity", 1);
    
  // 添加事件标题
  svg.selectAll(".flower-label")
    .data(all)
    .enter()
    .append("text")
    .attr("class", "flower-label")
    .attr("x", center.x)
    .attr("y", center.y)
    .attr("text-anchor", "middle")
    .attr("font-size", "10px")
    .attr("fill", "rgba(0, 0, 0, 0)")
    .attr("pointer-events", "none")
    .text(d => d.title)
    .transition()
    .delay(1000)
    .duration(500)
    .attr("x", d => d.x)
    .attr("y", d => d.y + (d.peak >= peakThreshold ? 25 : 30))
    .attr("fill", "rgba(0, 0, 0, 0.8)");

  // 图例 - 使用纯色
  const legend = svg.append("g")
    .attr("transform", `translate(20, ${height - 100})`);

  Object.entries(categoryColor).forEach(([category, color], i) => {
    const g = legend.append("g")
      .attr("transform", `translate(0, ${i * 22})`);
    
    g.append("circle")
      .attr("r", 8)
      .attr("fill", color);
    
    g.append("text")
      .attr("x", 15)
      .attr("y", 5)
      .text(category)
      .attr("fill", "#333")
      .attr("font-size", "14px");
  });
}

function renderTimeline() {
  const timelineDiv = document.getElementById("timeline");
  timelineDiv.innerHTML = ""; // 清空旧图
  timelineDiv.style.overflowX = "auto";

  const svgWidth = 2000;
  const svgHeight = 200;

  const timeline = d3.select(timelineDiv).append("svg")
    .attr("width", svgWidth)
    .attr("height", svgHeight);

  // 计算时间范围
  const minDate = d3.min(events, d => d.start);
  const maxDate = d3.max(events, d => d.end);
  
  const x = d3.scaleTime()
    .domain([minDate, maxDate])
    .range([60, svgWidth - 60]);

  // 创建平滑的时间序列数据
  const timeSeries = [];
  const numPoints = 100;
  const timeRange = maxDate - minDate;
  
  for (let i = 0; i <= numPoints; i++) {
    const date = new Date(minDate.getTime() + (timeRange * i / numPoints));
    // 找到最近的事件峰值
    let peakValue = 0;
    events.forEach(event => {
      if (event.start <= date && date <= event.end) {
        if (event.peak > peakValue) {
          peakValue = event.peak;
        }
      }
    });
    timeSeries.push({date, peak: peakValue});
  }

  const area = d3.area()
    .x(d => x(d.date))
    .y0(svgHeight)
    .y1(d => svgHeight - (d.peak || 0) * 100)
    .curve(d3.curveMonotoneX);

  // 渐变色定义
  const defs = timeline.append("defs");
  const gradient = defs.append("linearGradient")
    .attr("id", "mountain-gradient")
    .attr("x1", "0%").attr("x2", "0%")
    .attr("y1", "0%").attr("y2", "100%");

  gradient.selectAll("stop")
    .data([
      { offset: "0%", color: "#80c1ff" },
      { offset: "100%", color: "#cce5ff" }
    ])
    .enter()
    .append("stop")
    .attr("offset", d => d.offset)
    .attr("stop-color", d => d.color);

  // 山峰区域图
  timeline.append("path")
    .datum(timeSeries)
    .attr("class", "mountain")
    .attr("d", area)
    .attr("fill", "url(#mountain-gradient)");

  // 时间轴
  timeline.append("g")
    .attr("transform", "translate(0,180)")
    .call(d3.axisBottom(x).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y")));

  // 时间段横条
  timeline.selectAll(".duration-bar")
    .data(events)
    .enter()
    .append("rect")
    .attr("class", "duration-bar")
    .attr("x", d => x(d.start))
    .attr("y", 150)
    .attr("height", 4)
    .attr("width", d => Math.max(2, x(d.end) - x(d.start)))
    .attr("fill", "#aaa")
    .on("click", (e, d) => showEvent(d));

  // 事件标记
  const markers = timeline.selectAll(".event-marker")
    .data(events)
    .enter()
    .append("g")
    .attr("class", "event-marker")
    .attr("transform", d => `translate(${x(d.start)}, 180)`)
    .on("click", (e, d) => showEvent(d));

  // 图标
  markers.append("circle")
    .attr("r", 6)
    .attr("fill", d => categoryColor[d.category] || "#9E9E9E")
    .attr("stroke", "#333")
    .attr("stroke-width", 1);

  // 标签文字
  const label = markers.append("text")
    .attr("y", (d, i) => i % 2 === 0 ? -45 : -70)
    .attr("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("font-family", "sans-serif")
    .attr("fill", "#333");

  // 用 tspan 分行写完整文本
  label.each(function(d) {
    const textLines = d.title.split("：");
    textLines.forEach((line, i) => {
      d3.select(this).append("tspan")
        .attr("x", 0)
        .attr("dy", i === 0 ? 0 : "1.2em")
        .text(line);
    });
  });

  // 箭头线条
  markers.append("line")
    .attr("x1", 0).attr("y1", -28)
    .attr("x2", 0).attr("y2", -5)
    .attr("stroke", "#999")
    .attr("stroke-width", 1);

  // Tooltip 提示
  markers.append("title")
    .text(d => `${d.title}：${d3.timeFormat("%Y-%m-%d")(d.start)} - ${d3.timeFormat("%Y-%m-%d")(d.end)}`);

  // 存储事件位置用于自动滚动
  events.forEach(d => {
    d.timelineX = x(d.start);
  });

  // 拖拽滚动逻辑
  let isDragging = false, startX = 0, scrollLeft = 0;
  timelineDiv.addEventListener("mousedown", e => {
    isDragging = true;
    startX = e.pageX - timelineDiv.offsetLeft;
    scrollLeft = timelineDiv.scrollLeft;
  });
  timelineDiv.addEventListener("mouseleave", () => isDragging = false);
  timelineDiv.addEventListener("mouseup", () => isDragging = false);
  timelineDiv.addEventListener("mousemove", e => {
    if (!isDragging) return;
    const xPos = e.pageX - timelineDiv.offsetLeft;
    const walk = (xPos - startX) * 1.5;
    timelineDiv.scrollLeft = scrollLeft - walk;
  });
}

function showEvent(event, fromAutoplay = false) {
  if (!fromAutoplay) {
    stopAutoPlay();
    isManualInterruption = true;
  }

  // 更新当前索引
  currentIndex = events.findIndex(e => e.title === event.title);
  
  // 高亮当前事件
  d3.selectAll(".event-marker").classed("active", false);
  d3.selectAll(".flower-node").classed("active", false);
  
  d3.selectAll(".event-marker").filter(d => d === event).classed("active", true);
  d3.selectAll(".flower-node").filter(d => d === event).classed("active", true);

  // 更新事件显示
  document.getElementById("event-title").textContent = event.title;
  document.getElementById("event-description").textContent = event.description;
  
  // 格式化日期
  const startDate = event.start.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  
  let dateText = `日期: ${startDate}`;
  if (event.start.getTime() !== event.end.getTime()) {
    const endDate = event.end.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    dateText = `日期: ${startDate} 至 ${endDate}`;
  }
  
  document.getElementById("event-time").textContent = dateText;
  
  // 设置媒体项
  mediaItems = [];
  if (event.image) {
    event.image.forEach(img => {
      mediaItems.push({ type: "image", src: "images/" + img });
    });
  }
  
  mediaIndex = 0;
  showMediaItem(mediaIndex);
  
  // 滚动时间线到当前事件
  const timelineDiv = document.getElementById('timeline');
  const containerWidth = timelineDiv.clientWidth;
  const scrollLeft = event.timelineX - containerWidth / 2;
  timelineDiv.scrollLeft = scrollLeft;
}

function showMediaItem(index) {
  const mediaContainer = document.getElementById("media-container");
  mediaContainer.innerHTML = "";
  
  if (index < 0 || index >= mediaItems.length) return;
  
  const item = mediaItems[index];
  
  if (item.type === "image") {
    const img = document.createElement("img");
    img.src = item.src;
    img.className = "media-display";
    img.alt = "事件图片";
    mediaContainer.appendChild(img);
    scheduleNext();
  }
}

function nextMedia() {
  mediaIndex = (mediaIndex + 1) % mediaItems.length;
  showMediaItem(mediaIndex);
}

function prevMedia() {
  mediaIndex = (mediaIndex - 1 + mediaItems.length) % mediaItems.length;
  showMediaItem(mediaIndex);
}

function scheduleNext() {
  clearTimeout(mediaTimer);
  if (mediaItems.length > 1) {
    mediaTimer = setTimeout(() => {
      nextMedia();
    }, 4000);
  }
}

function nextEvent() {
  currentIndex = (currentIndex + 1) % events.length;
  showEvent(events[currentIndex]);
}

function prevEvent() {
  currentIndex = (currentIndex - 1 + events.length) % events.length;
  showEvent(events[currentIndex]);
}

function startAutoPlay() {
  stopAutoPlay();
  isManualInterruption = false;
  
  autoplayTimer = setInterval(() => {
    if (!isManualInterruption) {
      nextEvent();
    }
  }, 5000);
}

function stopAutoPlay() {
  if (autoplayTimer) {
    clearInterval(autoplayTimer);
    autoplayTimer = null;
  }
}

document.addEventListener("DOMContentLoaded", () => {
  renderFlowerPlot();
  renderTimeline();
  showEvent(events[0]);
  startAutoPlay();
});
</script>

</body>
</html>