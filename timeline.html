<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>人物时间线</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/story.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="events.js" defer></script>
</head>
<body>

<div id="controls">
  <button onclick="startAutoPlay()">▶️ 播放</button>
  <button onclick="stopAutoPlay()">⏸ 暂停</button>
</div>

<div id="main">
  <div id="flower-plot"></div>
  <div id="event-display"></div>
</div>

<div id="timeline"></div>

<script>

let currentIndex = 0;
let autoplayTimer = null;
let isManualInterruption = false;  

const peakThreshold = 0.6;
const categoryColor = {
  "职业": "#4CAF50",
  "家庭": "#2196F3",
  "社会责任": "#FFC107",
  "其他": "#9E9E9E"
};

function showEvent(d, fromAutoplay = false) {
  if (!fromAutoplay) {
    // 用户点击时中断自动播放
    stopAutoPlay();
    isManualInterruption = true;
  }

  d3.selectAll(".event-marker").classed("active", e => e === d);
  d3.selectAll(".flower-node").classed("active", e => e === d);

  const display = d3.select("#event-display").html("");
  const box = display.append("div").attr("class", "event-box");
  box.append("h2").text(d.title);
  box.append("p").text(d.description);

  if (d.images) {
    d.images.forEach(img => box.append("img").attr("src", "images/" + img));
  }

  if (d.video) {
    box.append("video")
      .attr("src", "videos/" + d.video)
      .attr("controls", true)
      .attr("autoplay", true);
  }
}


function startAutoPlay() {
  stopAutoPlay();
  isManualInterruption = false; // 重置标志

  autoplayTimer = setInterval(() => {
    if (!isManualInterruption) {
      showEvent(events[currentIndex], true); // 自动播放用 true
      currentIndex = (currentIndex + 1) % events.length;
    }
  }, 5000);
}


function stopAutoPlay() {
  if (autoplayTimer) {
    clearInterval(autoplayTimer);
    autoplayTimer = null;
  }
}

function renderTimeline() {
  const timeline = d3.select("#timeline").append("svg")
    .attr("width", 2000)
    .attr("height", 200);

  const x = d3.scaleTime()
    .domain(d3.extent(events, d => d.time))
    .range([60, 1940]);

  const area = d3.area()
    .x(d => x(d.time))
    .y0(200)
    .y1(d => 200 - (d.peak || 0) * 100);

  timeline.append("path")
    .datum(events)
    .attr("class", "mountain")
    .attr("d", area);

  timeline.append("g")
    .attr("transform", "translate(0,180)")
    .call(d3.axisBottom(x).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y")));

  const markers = timeline.selectAll(".event-marker")
    .data(events)
    .enter()
    .append("g")
    .attr("transform", d => `translate(${x(d.time)},140)`)
    .on("click", (e, d) => showEvent(d));

  markers.append("rect")
    .attr("class", "event-marker")
    .attr("x", -25)
    .attr("y", -25)
    .attr("width", 50)
    .attr("height", 50)
    .attr("rx", 6)
    .attr("ry", 6);

  markers.append("text")
    .attr("class", "marker-label")
    .attr("y", 5)
    .text(d => d.title);

  let isDragging = false;
  let startX = 0;
  let scrollLeft = 0;

  const timelineDiv = document.getElementById("timeline");
  timelineDiv.style.overflowX = "auto";

  timelineDiv.addEventListener("mousedown", e => {
    isDragging = true;
    startX = e.pageX - timelineDiv.offsetLeft;
    scrollLeft = timelineDiv.scrollLeft;
  });

  timelineDiv.addEventListener("mouseleave", () => isDragging = false);
  timelineDiv.addEventListener("mouseup", () => isDragging = false);
  timelineDiv.addEventListener("mousemove", e => {
    if (!isDragging) return;
    const x = e.pageX - timelineDiv.offsetLeft;
    const walk = (x - startX) * 1.5;
    timelineDiv.scrollLeft = scrollLeft - walk;
  });
}
// 渲染花朵图
// function renderFlowerPlot() {
//   const width = 400;
//   const height = 400;
//   const center = { x: width / 2, y: height / 2 };
//   const radius = 100;

//   const svg = d3.select("#flower-plot")
//     .append("svg")
//     .attr("width", width)
//     .attr("height", height);

//   svg.append("circle")
//     .attr("cx", center.x)
//     .attr("cy", center.y)
//     .attr("r", radius)
//     .attr("fill", "none")
//     .attr("stroke", "#aaa")
//     .attr("stroke-width", 2);

//   const inside = events.filter(d => d.peak >= peakThreshold);
//   const outside = events.filter(d => d.peak < peakThreshold);

//   inside.forEach((d, i) => {
//     const angle = 2 * Math.PI * i / inside.length;
//     d.x = center.x + radius * 0.5 * Math.cos(angle);
//     d.y = center.y + radius * 0.5 * Math.sin(angle);
//   });

//   outside.forEach((d, i) => {
//     const angle = 2 * Math.PI * i / outside.length;
//     d.x = center.x + radius * 1.4 * Math.cos(angle);
//     d.y = center.y + radius * 1.4 * Math.sin(angle);
//   });

//   const all = [...inside, ...outside];

//   svg.selectAll(".flower-node")
//     .data(all)
//     .enter()
//     .append("circle")
//     .attr("class", "flower-node")
//     .attr("cx", d => d.x)
//     .attr("cy", d => d.y)
//     .attr("r", 10)
//     .attr("fill", d => categoryColor[d.category] || categoryColor["其他"])
//     .on("click", (e, d) => {
//       showEvent(d);
//     });
// }
function renderFlowerPlot() {
  const width = 500;
  const height = 500;
  const center = { x: width / 2, y: height / 2 };
  const radius = 120;

  const svg = d3.select("#flower-plot")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  // 渐变和阴影
  const defs = svg.append("defs");

  Object.entries(categoryColor).forEach(([key, color]) => {
    const gradient = defs.append("radialGradient")
      .attr("id", `grad-${key}`)
      .attr("cx", "50%").attr("cy", "50%").attr("r", "50%");
    gradient.append("stop").attr("offset", "0%").attr("stop-color", d3.color(color).brighter(1));
    gradient.append("stop").attr("offset", "100%").attr("stop-color", color);
  });

  defs.append("filter")
    .attr("id", "drop-shadow")
    .html(`<feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#aaa" />`);

  // 中心圆和标题
  svg.append("circle")
    .attr("cx", center.x)
    .attr("cy", center.y)
    .attr("r", radius)
    .attr("fill", "none")
    .attr("stroke", "#ccc")
    .attr("stroke-width", 2)
    .attr("stroke-dasharray", "4 2");

  svg.append("text")
    .attr("x", center.x)
    .attr("y", center.y + 5)
    .attr("text-anchor", "middle")
    .attr("font-size", "16px")
    .attr("fill", "#666")
    .text("人物生平概览");

  const inside = events.filter(d => d.peak >= peakThreshold);
  const outside = events.filter(d => d.peak < peakThreshold);

  // 坐标计算
  inside.forEach((d, i) => {
    const angle = 2 * Math.PI * i / inside.length;
    d.x = center.x + radius * 0.6 * Math.cos(angle);
    d.y = center.y + radius * 0.6 * Math.sin(angle);
  });

  outside.forEach((d, i) => {
    const angle = 2 * Math.PI * i / outside.length;
    d.x = center.x + radius * 1.4 * Math.cos(angle);
    d.y = center.y + radius * 1.4 * Math.sin(angle);
  });

  const all = [...inside, ...outside];

  // 绽放动画
  svg.selectAll(".flower-node")
    .data(all)
    .enter()
    .append("circle")
    .attr("class", "flower-node")
    .attr("cx", center.x)
    .attr("cy", center.y)
    .attr("r", 0)
    .attr("fill", d => `url(#grad-${d.category})`)
    .attr("filter", "url(#drop-shadow)")
    .transition()
    .duration(1000)
    .attr("cx", d => d.x)
    .attr("cy", d => d.y)
    .attr("r", d => 6 + d.peak * 6) // 根据 peak 动态设置大小
    .on("end", function() {
      d3.select(this)
        .on("click", (e, d) => showEvent(d))
        .style("cursor", "pointer");
    });

  // 图例
  const legend = svg.append("g")
    .attr("transform", `translate(20, ${height - 100})`);

  Object.entries(categoryColor).forEach(([key, color], i) => {
    const g = legend.append("g")
      .attr("transform", `translate(0, ${i * 22})`);
    g.append("circle")
      .attr("r", 8)
      .attr("fill", `url(#grad-${key})`);
    g.append("text")
      .attr("x", 15)
      .attr("y", 5)
      .text(key)
      .attr("fill", "#333")
      .attr("font-size", "14px");
  });
}

document.addEventListener("DOMContentLoaded", () => {
  renderFlowerPlot();
  renderTimeline();
  showEvent(events[0]);
  startAutoPlay();
});
</script>

</body>
</html>
